import React, { useState, useEffect } from 'react';
import { useParams, useNavigate } from 'react-router-dom';
import { 
  ArrowLeft,
  AlertTriangle,
  Wrench,
  Camera,
  MapPin,
  Save,
  Upload,
  X
} from 'lucide-react';

interface MoldBasicInfo {
  moldId: string;
  name: string;
  location: string;
}

interface RepairRequestData {
  // ê¸°ë³¸ ì •ë³´
  moldId: string;
  moldName: string;
  requestNumber: string;
  requestDate: string;
  requester: string;
  requesterDept: string;
  location: string;
  requestType: string;
  urgency: 'low' | 'medium' | 'high' | 'urgent';
  responsiblePerson: string;
  responsibleContact: string;
  
  // ì´ìƒ / ìš”ì²­ ìƒì„¸
  issueCategory: string;
  issueDetail: string;
  issueDescription: string;
  issueImages: File[];
  
  // ê¸´ê¸‰ë„
  urgencyReason: string;
  expectedCompletionDate: string;
  
  // ìŠ¹ì¸
  approvalRequired: boolean;
  approver: string;
  
  // ìˆ˜ë¦¬ ì„¸ë¶€ì •ë³´ (ìˆ˜ë¦¬ì²˜ ì…ë ¥)
  repairType: string;
  repairMethod: string;
  repairWorker: string;
  repairDetail: string;
  repairCost: number;
  repairParts: string;
  repairStartTime: string;
  repairEndTime: string;
  repairImages: File[];
  
  // í’ˆì§ˆê´€ë¦¬
  qualityCheck: string;
  qualityCheckResult: string;
  qualityInspector: string;
  
  // ìŠ¹ì¸ / ì •ì‚°
  costApproval: string;
  costApprover: string;
  invoiceRequired: boolean;
  
  // ì •ì‚°
  invoiceNumber: string;
  invoiceDate: string;
  invoiceAmount: number;
  
  // ê²°ê³¼ ë° ì¶”ì 
  finalResult: string;
  finalInspector: string;
  completionDate: string;
  reportFile: File | null;
  
  // GPS ìœ„ì¹˜
  gpsLocation: {
    latitude: number;
    longitude: number;
    address: string;
  } | null;
  
  // ìƒíƒœ ì¶”ì 
  status: 'requested' | 'approved' | 'in_repair' | 'quality_check' | 'completed' | 'rejected';
  statusHistory: {
    status: string;
    timestamp: string;
    user: string;
    note: string;
  }[];
}

const RepairRequest: React.FC = () => {
  const { moldId } = useParams<{ moldId: string }>();
  const navigate = useNavigate();
  
  const [moldInfo, setMoldInfo] = useState<MoldBasicInfo | null>(null);
  const [loading, setLoading] = useState(true);
  const [submitting, setSubmitting] = useState(false);
  const [error, setError] = useState<string | null>(null);
  const [isGettingLocation, setIsGettingLocation] = useState(false);
  
  const [requestData, setRequestData] = useState<RepairRequestData>({
    moldId: moldId || '',
    moldName: '',
    requestNumber: '',
    requestDate: new Date().toISOString().split('T')[0],
    requester: '',
    requesterDept: '',
    location: '',
    requestType: '',
    urgency: 'medium',
    responsiblePerson: '',
    responsibleContact: '',
    issueCategory: '',
    issueDetail: '',
    issueDescription: '',
    issueImages: [],
    urgencyReason: '',
    expectedCompletionDate: '',
    approvalRequired: false,
    approver: '',
    repairType: '',
    repairMethod: '',
    repairWorker: '',
    repairDetail: '',
    repairCost: 0,
    repairParts: '',
    repairStartTime: '',
    repairEndTime: '',
    repairImages: [],
    qualityCheck: '',
    qualityCheckResult: '',
    qualityInspector: '',
    costApproval: '',
    costApprover: '',
    invoiceRequired: false,
    invoiceNumber: '',
    invoiceDate: '',
    invoiceAmount: 0,
    finalResult: '',
    finalInspector: '',
    completionDate: '',
    reportFile: null,
    gpsLocation: null,
    status: 'requested',
    statusHistory: []
  });


  useEffect(() => {
    if (moldId) {
      fetchMoldInfo();
      getCurrentLocation();
    }
  }, [moldId]);

  const fetchMoldInfo = async () => {
    try {
      const token = localStorage.getItem('qr_session_token');
      if (!token) {
        throw new Error('QR ì„¸ì…˜ì´ ë§Œë£Œë˜ì—ˆìŠµë‹ˆë‹¤.');
      }

      const response = await fetch(`http://localhost:5001/api/worker/mold/${moldId}`, {
        headers: {
          'Authorization': `Bearer ${token}`
        }
      });

      if (!response.ok) {
        throw new Error('ê¸ˆí˜• ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
      }

      const data = await response.json();
      setMoldInfo({
        moldId: data.moldId,
        name: data.name,
        location: data.location
      });
      
      setRequestData(prev => ({
        ...prev,
        moldName: data.name,
        location: data.location
      }));
    } catch (error) {
      console.error('Mold info fetch error:', error);
      setError(error instanceof Error ? error.message : 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
    } finally {
      setLoading(false);
    }
  };

  const getCurrentLocation = () => {
    setIsGettingLocation(true);
    
    if (navigator.geolocation) {
      navigator.geolocation.getCurrentPosition(
        async (position) => {
          const { latitude, longitude } = position.coords;
          
          try {
            const address = `ìœ„ë„: ${latitude.toFixed(6)}, ê²½ë„: ${longitude.toFixed(6)}`;
            
            setRequestData(prev => ({
              ...prev,
              gpsLocation: {
                latitude,
                longitude,
                address
              }
            }));
          } catch (error) {
            console.error('ì£¼ì†Œ ë³€í™˜ ì‹¤íŒ¨:', error);
          } finally {
            setIsGettingLocation(false);
          }
        },
        (error) => {
          console.error('ìœ„ì¹˜ ì •ë³´ íšë“ ì‹¤íŒ¨:', error);
          setError('ìœ„ì¹˜ ì •ë³´ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
          setIsGettingLocation(false);
        }
      );
    } else {
      setError('ì´ ë¸Œë¼ìš°ì €ëŠ” ìœ„ì¹˜ ì„œë¹„ìŠ¤ë¥¼ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.');
      setIsGettingLocation(false);
    }
  };

  const handleInputChange = (field: keyof RepairRequestData, value: any) => {
    setRequestData(prev => ({
      ...prev,
      [field]: value
    }));
  };

  const handleImageUpload = (event: React.ChangeEvent<HTMLInputElement>) => {
    const files = Array.from(event.target.files || []);
    setRequestData(prev => ({
      ...prev,
      issueImages: [...prev.issueImages, ...files]
    }));
  };

  const removeImage = (index: number) => {
    setRequestData(prev => ({
      ...prev,
      issueImages: prev.issueImages.filter((_: File, i: number) => i !== index)
    }));
  };

  const fillTestData = () => {
    setRequestData(prev => ({
      ...prev,
      requester: 'ì‘ì—…ìA',
      requesterDept: 'ìƒì‚°ë¶€',
      urgency: 'high',
      issueCategory: 'ì´ìƒì¢…ë¥˜',
      issueDetail: 'ì´ì í„° ë¬¸ì œ',
      issueDescription: 'ì´ì í„° í•€ì´ ì œëŒ€ë¡œ ì‘ë™í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤. ì œí’ˆì´ ê¸ˆí˜•ì—ì„œ ë¶„ë¦¬ë˜ì§€ ì•Šì•„ ìƒì‚°ì´ ì¤‘ë‹¨ë˜ì—ˆìŠµë‹ˆë‹¤.',
      urgencyReason: 'ìƒì‚° ì¤‘ë‹¨',
      responsiblePerson: 'ê¹€ì±…ì„',
      responsibleContact: '010-1234-5678'
    }));
  };

  const handleSubmit = async () => {
    if (!requestData.requester || !requestData.issueCategory || !requestData.issueDescription) {
      alert('í•„ìˆ˜ í•­ëª©ì„ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.');
      return;
    }

    try {
      setSubmitting(true);
      const token = localStorage.getItem('qr_session_token');
      
      const response = await fetch('http://localhost:5001/api/worker/repair-request', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${token}`
        },
        body: JSON.stringify(requestData)
      });

      if (!response.ok) {
        throw new Error('ìˆ˜ë¦¬ ìš”ì²­ ë“±ë¡ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
      }

      const result = await response.json();
      
      alert(`ìˆ˜ë¦¬ ìš”ì²­ì´ ì„±ê³µì ìœ¼ë¡œ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤!\nìš”ì²­ë²ˆí˜¸: ${result.repairRequest.requestNumber}\nê´€ë¦¬ìì—ê²Œ ê¸´ê¸‰ ì•Œë¦¼ì´ ì „ì†¡ë˜ì—ˆìŠµë‹ˆë‹¤.`);
      navigate(`/worker/mold/${moldId}`);
    } catch (error) {
      console.error('Submit error:', error);
      alert(error instanceof Error ? error.message : 'ë“±ë¡ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
    } finally {
      setSubmitting(false);
    }
  };

  if (loading) {
    return (
      <div className="min-h-screen bg-neutral-50 flex items-center justify-center">
        <div className="text-center">
          <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-primary-600 mx-auto mb-4"></div>
          <p className="text-neutral-600">ê¸ˆí˜• ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
        </div>
      </div>
    );
  }

  if (error) {
    return (
      <div className="min-h-screen bg-neutral-50 flex items-center justify-center p-4">
        <div className="bg-white rounded-lg shadow-sm p-6 max-w-md w-full text-center">
          <AlertTriangle className="h-12 w-12 text-red-500 mx-auto mb-4" />
          <h2 className="text-lg font-semibold text-neutral-900 mb-2">ì˜¤ë¥˜ ë°œìƒ</h2>
          <p className="text-neutral-600 mb-4">{error}</p>
          <button
            onClick={() => navigate(`/worker/mold/${moldId}`)}
            className="w-full btn-primary"
          >
            ëŒì•„ê°€ê¸°
          </button>
        </div>
      </div>
    );
  }

  return (
    <div className="min-h-screen bg-neutral-50">
      {/* Header */}
      <div className="bg-white border-b border-neutral-200 sticky top-0 z-10">
        <div className="px-4 py-3">
          <div className="flex items-center justify-between">
            <button
              onClick={() => navigate(-1)}
              className="p-2 text-neutral-500 hover:text-neutral-700"
            >
              <ArrowLeft className="h-5 w-5" />
            </button>
            <div className="text-center">
              <h1 className="text-lg font-semibold text-neutral-900">ìˆ˜ë¦¬ ìš”ì²­</h1>
              <p className="text-sm text-neutral-600">{moldInfo?.moldId} - {moldInfo?.name}</p>
            </div>
            <div className="flex gap-2">
              <button
                onClick={fillTestData}
                className="btn-secondary text-sm"
              >
                í…ŒìŠ¤íŠ¸ ë°ì´í„°
              </button>
              <button
                onClick={handleSubmit}
                disabled={submitting}
                className="btn-primary disabled:opacity-50 disabled:cursor-not-allowed"
              >
                <Save className="mr-2 h-4 w-4" />
                {submitting ? 'ì „ì†¡ ì¤‘...' : 'ìš”ì²­ ì „ì†¡'}
              </button>
            </div>
          </div>
        </div>
      </div>

      <div className="max-w-4xl mx-auto p-4 space-y-6">
        {/* ê¸ˆí˜• ì •ë³´ */}
        {moldInfo && (
          <div className="bg-red-50 border border-red-200 rounded-lg p-4">
            <div className="flex items-center gap-3">
              <div className="p-2 bg-red-100 rounded-lg">
                <Wrench className="h-5 w-5 text-red-600" />
              </div>
              <div>
                <h3 className="text-lg font-semibold text-neutral-900">{moldInfo.moldId}</h3>
                <p className="text-neutral-600">{moldInfo.name}</p>
                <p className="text-sm text-neutral-500">ìœ„ì¹˜: {moldInfo.location}</p>
              </div>
            </div>
          </div>
        )}

        {/* 1. ê¸°ë³¸ ì •ë³´ */}
        <div className="bg-white rounded-lg border-2 border-red-200 p-5 shadow-md">
          <div className="flex items-center gap-2 mb-4">
            <span className="text-2xl">ğŸ“Œ</span>
            <h4 className="text-lg font-bold text-neutral-900">1. ê¸°ë³¸ ì •ë³´</h4>
          </div>
          <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <label className="block text-sm font-medium text-neutral-700 mb-2">ìˆ˜ë¦¬ìš”ì²­ë²ˆí˜¸</label>
              <input type="text" value={requestData.requestNumber || 'ìë™ìƒì„±'} disabled
                className="w-full px-4 py-2 bg-gray-50 border border-neutral-300 rounded-lg" />
            </div>
            <div>
              <label className="block text-sm font-medium text-neutral-700 mb-2">ê¸ˆí˜•ë²ˆí˜¸</label>
              <input type="text" value={requestData.moldId} disabled
                className="w-full px-4 py-2 bg-gray-50 border border-neutral-300 rounded-lg" />
            </div>
            <div>
              <label className="block text-sm font-medium text-neutral-700 mb-2">ê¸ˆí˜•/í’ˆë²ˆ</label>
              <input type="text" value={requestData.moldName} disabled
                className="w-full px-4 py-2 bg-gray-50 border border-neutral-300 rounded-lg" />
            </div>
            <div>
              <label className="block text-sm font-medium text-neutral-700 mb-2">ìš”ì²­ì¼ì *</label>
              <input type="date" value={requestData.requestDate}
                onChange={(e) => handleInputChange('requestDate', e.target.value)}
                className="w-full px-4 py-2 border border-neutral-300 rounded-lg focus:ring-2 focus:ring-blue-500" />
            </div>
            <div>
              <label className="block text-sm font-medium text-neutral-700 mb-2">ìš”ì²­ì *</label>
              <input type="text" value={requestData.requester}
                onChange={(e) => handleInputChange('requester', e.target.value)}
                className="w-full px-4 py-2 border border-neutral-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                placeholder="ìš”ì²­ìëª…" required />
            </div>
            <div>
              <label className="block text-sm font-medium text-neutral-700 mb-2">ìš”ì²­ì—…ì²´ëª…</label>
              <input type="text" value={requestData.requesterDept}
                onChange={(e) => handleInputChange('requesterDept', e.target.value)}
                className="w-full px-4 py-2 border border-neutral-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                placeholder="ë¶€ì„œ/ì—…ì²´ëª…" />
            </div>
            <div>
              <label className="block text-sm font-medium text-neutral-700 mb-2">ìˆ˜ë¦¬ì²˜(ì˜ˆì •)</label>
              <input type="text" value={requestData.responsiblePerson}
                onChange={(e) => handleInputChange('responsiblePerson', e.target.value)}
                className="w-full px-4 py-2 border border-neutral-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                placeholder="ë‹´ë‹¹ ìˆ˜ë¦¬ì²˜" />
            </div>
            <div>
              <label className="block text-sm font-medium text-neutral-700 mb-2">ë‹´ë‹¹ ë¶„ì„ì</label>
              <input type="text" value={requestData.responsibleContact}
                onChange={(e) => handleInputChange('responsibleContact', e.target.value)}
                className="w-full px-4 py-2 border border-neutral-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                placeholder="ë¶„ì„ ë‹´ë‹¹ì" />
            </div>
          </div>
        </div>

        {/* 2. ì´ìƒ / ìš”ì²­ ìƒì„¸ */}
        <div className="bg-white rounded-lg border-2 border-orange-200 p-5 shadow-md">
          <div className="flex items-center gap-2 mb-4">
            <span className="text-2xl">ğŸ“‹</span>
            <h4 className="text-lg font-bold text-neutral-900">2. ì´ìƒ / ìš”ì²­ ìƒì„¸</h4>
          </div>
          <div className="space-y-4">
            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div>
                <label className="block text-sm font-medium text-neutral-700 mb-2">ì´ìƒì¢…ë¥˜ *</label>
                <select value={requestData.issueCategory}
                  onChange={(e) => handleInputChange('issueCategory', e.target.value)}
                  className="w-full px-4 py-2 border border-neutral-300 rounded-lg focus:ring-2 focus:ring-orange-500">
                  <option value="">ì„ íƒ</option>
                  <option value="ê¸ˆí˜• ì†ìƒ">ê¸ˆí˜• ì†ìƒ</option>
                  <option value="ëƒ‰ê°ëˆ„ìˆ˜">ëƒ‰ê°ëˆ„ìˆ˜</option>
                  <option value="ê²Œì´íŠ¸ íŒŒì†">ê²Œì´íŠ¸ íŒŒì†</option>
                </select>
              </div>
              <div>
                <label className="block text-sm font-medium text-neutral-700 mb-2">ì´ìƒìƒì„¸ë‚´ìš©</label>
                <input type="text" value={requestData.issueDetail}
                  onChange={(e) => handleInputChange('issueDetail', e.target.value)}
                  className="w-full px-4 py-2 border border-neutral-300 rounded-lg focus:ring-2 focus:ring-orange-500"
                  placeholder="ì›ì¸ / í˜„ìƒ ì„¤ëª…" />
              </div>
            </div>
            <div>
              <label className="block text-sm font-medium text-neutral-700 mb-2">ì´ìƒì‚¬ì§„</label>
              <input type="file" multiple accept="image/*" onChange={handleImageUpload}
                className="w-full px-4 py-2 border border-neutral-300 rounded-lg" />
            </div>
          </div>
        </div>

        {/* 3. ê¸´ê¸‰ë„ */}
        <div className="bg-white rounded-lg border-2 border-yellow-200 p-5 shadow-md">
          <div className="flex items-center gap-2 mb-4">
            <span className="text-2xl">âš ï¸</span>
            <h4 className="text-lg font-bold text-neutral-900">3. ê¸´ê¸‰ë„</h4>
          </div>
          <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <label className="block text-sm font-medium text-neutral-700 mb-2">ìˆ˜ë¦¬ê¸´ê¸‰ë„ *</label>
              <select value={requestData.urgency}
                onChange={(e) => handleInputChange('urgency', e.target.value)}
                className="w-full px-4 py-2 border border-neutral-300 rounded-lg focus:ring-2 focus:ring-yellow-500">
                <option value="low">ë‚®ìŒ</option>
                <option value="medium">ë³´í†µ</option>
                <option value="high">ë†’ìŒ</option>
                <option value="urgent">ê¸´ê¸‰</option>
              </select>
            </div>
            <div>
              <label className="block text-sm font-medium text-neutral-700 mb-2">ì˜ˆìƒì¢…ë£Œì¼ì</label>
              <input type="date" value={requestData.expectedCompletionDate}
                onChange={(e) => handleInputChange('expectedCompletionDate', e.target.value)}
                className="w-full px-4 py-2 border border-neutral-300 rounded-lg focus:ring-2 focus:ring-yellow-500" />
            </div>
            <div className="md:col-span-2">
              <label className="block text-sm font-medium text-neutral-700 mb-2">ê¸´ê¸‰ì‚¬ìœ </label>
              <textarea value={requestData.urgencyReason}
                onChange={(e) => handleInputChange('urgencyReason', e.target.value)}
                className="w-full px-4 py-2 border border-neutral-300 rounded-lg focus:ring-2 focus:ring-yellow-500"
                rows={2} placeholder="ê¸´ê¸‰ ìˆ˜ë¦¬ê°€ í•„ìš”í•œ ì´ìœ " />
            </div>
          </div>
        </div>

        {/* 4. ìˆ˜ë¦¬ ì„¸ë¶€ì •ë³´ (ìˆ˜ë¦¬ì²˜ ì…ë ¥) */}
        <div className="bg-white rounded-lg border-2 border-green-200 p-5 shadow-md">
          <div className="flex items-center gap-2 mb-4">
            <span className="text-2xl">ğŸ”§</span>
            <h4 className="text-lg font-bold text-neutral-900">4. ìˆ˜ë¦¬ ì„¸ë¶€ì •ë³´ (ìˆ˜ë¦¬ì²˜ ì…ë ¥)</h4>
          </div>
          <div className="space-y-4">
            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div>
                <label className="block text-sm font-medium text-neutral-700 mb-2">ìˆ˜ë¦¬ì²˜ë¶„</label>
                <select value={requestData.repairType}
                  onChange={(e) => handleInputChange('repairType', e.target.value)}
                  className="w-full px-4 py-2 border border-neutral-300 rounded-lg focus:ring-2 focus:ring-green-500">
                  <option value="">ì„ íƒ</option>
                  <option value="ì‹¤ì œ ìˆ˜ë¦¬ ìˆ˜í–‰ ì—…ì²´ëª…">ì‹¤ì œ ìˆ˜ë¦¬ ìˆ˜í–‰ ì—…ì²´ëª…</option>
                  <option value="ìì²´ìˆ˜ë¦¬">ìì²´ìˆ˜ë¦¬</option>
                </select>
              </div>
              <div>
                <label className="block text-sm font-medium text-neutral-700 mb-2">ìˆ˜ë¦¬ì‹œì‘ì¼ / ì™„ë£Œì¼</label>
                <div className="flex gap-2">
                  <input type="datetime-local" value={requestData.repairStartTime}
                    onChange={(e) => handleInputChange('repairStartTime', e.target.value)}
                    className="flex-1 px-4 py-2 border border-neutral-300 rounded-lg focus:ring-2 focus:ring-green-500" />
                </div>
              </div>
              <div>
                <label className="block text-sm font-medium text-neutral-700 mb-2">ìˆ˜ë¦¬ì‘ì—…ì</label>
                <input type="text" value={requestData.repairWorker}
                  onChange={(e) => handleInputChange('repairWorker', e.target.value)}
                  className="w-full px-4 py-2 border border-neutral-300 rounded-lg focus:ring-2 focus:ring-green-500"
                  placeholder="ìˆ˜ë¦¬ ë‹´ë‹¹ìëª…" />
              </div>
              <div>
                <label className="block text-sm font-medium text-neutral-700 mb-2">ìˆ˜ë¦¬ë‚´ìš©</label>
                <input type="text" value={requestData.repairDetail}
                  onChange={(e) => handleInputChange('repairDetail', e.target.value)}
                  className="w-full px-4 py-2 border border-neutral-300 rounded-lg focus:ring-2 focus:ring-green-500"
                  placeholder="êµì²´/ì²­ì†Œ/ê¸°íƒ€ ë“± ì¢…" />
              </div>
              <div>
                <label className="block text-sm font-medium text-neutral-700 mb-2">êµì²´ë¶€í’ˆë‚´ì—­</label>
                <input type="text" value={requestData.repairParts}
                  onChange={(e) => handleInputChange('repairParts', e.target.value)}
                  className="w-full px-4 py-2 border border-neutral-300 rounded-lg focus:ring-2 focus:ring-green-500"
                  placeholder="ë¶€í’ˆëª…, ìˆ˜ëŸ‰, ë‹¨ê°€" />
              </div>
              <div>
                <label className="block text-sm font-medium text-neutral-700 mb-2">ìˆ˜ë¦¬ì „ ì‚¬ì§„ / ìˆ˜ë¦¬í›„ ì‚¬ì§„</label>
                <input type="file" multiple accept="image/*"
                  className="w-full px-4 py-2 border border-neutral-300 rounded-lg" />
              </div>
            </div>
            <div>
              <label className="block text-sm font-medium text-neutral-700 mb-2">ìˆ˜ë¦¬í›„ ì‹œí—˜ì‚¬í•­</label>
              <textarea value={requestData.repairMethod}
                onChange={(e) => handleInputChange('repairMethod', e.target.value)}
                className="w-full px-4 py-2 border border-neutral-300 rounded-lg focus:ring-2 focus:ring-green-500"
                rows={2} placeholder="ì‹œí—˜ì„± ì—¬ë¶€/ê²°ê³¼" />
            </div>
            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div>
                <label className="block text-sm font-medium text-neutral-700 mb-2">í’ˆì§ˆê´€ì •</label>
                <select value={requestData.qualityCheck}
                  onChange={(e) => handleInputChange('qualityCheck', e.target.value)}
                  className="w-full px-4 py-2 border border-neutral-300 rounded-lg focus:ring-2 focus:ring-green-500">
                  <option value="">ì„ íƒ</option>
                  <option value="ì–‘í˜¸">ì–‘í˜¸</option>
                  <option value="ì¬ì‘ì—…">ì¬ì‘ì—…</option>
                </select>
              </div>
            </div>
          </div>
        </div>

        {/* 5. ìŠ¹ì¸/ì •ì‚° ê´€ë¦¬ */}
        <div className="bg-white rounded-lg border-2 border-purple-200 p-5 shadow-md">
          <div className="flex items-center gap-2 mb-4">
            <span className="text-2xl">ğŸ’°</span>
            <h4 className="text-lg font-bold text-neutral-900">5. ìŠ¹ì¸/ì •ì‚° ê´€ë¦¬</h4>
          </div>
          <div className="space-y-4">
            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div>
                <label className="block text-sm font-medium text-neutral-700 mb-2">ê²¬ì </label>
                <input type="text" value={requestData.costApproval}
                  onChange={(e) => handleInputChange('costApproval', e.target.value)}
                  className="w-full px-4 py-2 border border-neutral-300 rounded-lg focus:ring-2 focus:ring-purple-500"
                  placeholder="ê²¬ì ê¸ˆì•¡(ì›)" />
              </div>
              <div>
                <label className="block text-sm font-medium text-neutral-700 mb-2">ê²¬ì ì„œë¥˜ë¶€</label>
                <input type="file" accept=".pdf"
                  className="w-full px-4 py-2 border border-neutral-300 rounded-lg" />
              </div>
              <div>
                <label className="block text-sm font-medium text-neutral-700 mb-2">ìŠ¹ì¸</label>
                <input type="text" value={requestData.costApprover}
                  onChange={(e) => handleInputChange('costApprover', e.target.value)}
                  className="w-full px-4 py-2 border border-neutral-300 rounded-lg focus:ring-2 focus:ring-purple-500"
                  placeholder="ê²°ì¬ í›„ ìŠ¹ì¸ê¸ˆì•¡ ì…ë ¥" />
              </div>
              <div>
                <label className="block text-sm font-medium text-neutral-700 mb-2">ìŠ¹ì¸ì¼ì</label>
                <input type="date" value={requestData.invoiceDate}
                  onChange={(e) => handleInputChange('invoiceDate', e.target.value)}
                  className="w-full px-4 py-2 border border-neutral-300 rounded-lg focus:ring-2 focus:ring-purple-500" />
              </div>
              <div>
                <label className="block text-sm font-medium text-neutral-700 mb-2">ì •ì‚°</label>
                <input type="text" value={requestData.invoiceNumber}
                  onChange={(e) => handleInputChange('invoiceNumber', e.target.value)}
                  className="w-full px-4 py-2 border border-neutral-300 rounded-lg focus:ring-2 focus:ring-purple-500"
                  placeholder="ì„¸ê¸ˆê³„ì‚°ì„œë²ˆí˜¸ / ì§€ê¸‰ì¼" />
              </div>
            </div>
          </div>
        </div>

        {/* 6. ê²°ê³¼ ë° ì¶”ì  ê´€ë¦¬ */}
        <div className="bg-white rounded-lg border-2 border-indigo-200 p-5 shadow-md">
          <div className="flex items-center gap-2 mb-4">
            <span className="text-2xl">ğŸ“Š</span>
            <h4 className="text-lg font-bold text-neutral-900">6. ê²°ê³¼ ë° ì¶”ì  ê´€ë¦¬</h4>
          </div>
          <div className="space-y-4">
            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div>
                <label className="block text-sm font-medium text-neutral-700 mb-2">ê²°ê³¼</label>
                <select value={requestData.finalResult}
                  onChange={(e) => handleInputChange('finalResult', e.target.value)}
                  className="w-full px-4 py-2 border border-neutral-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                  <option value="">ì„ íƒ</option>
                  <option value="ìµœì¢…ìˆ˜ë¦¬ê²°ê³¼">ìµœì¢…ìˆ˜ë¦¬ê²°ê³¼</option>
                  <option value="ì–‘í˜¸">ì–‘í˜¸</option>
                  <option value="ì¬ì‘ì—…">ì¬ì‘ì—…</option>
                </select>
              </div>
              <div>
                <label className="block text-sm font-medium text-neutral-700 mb-2">ê²€ìˆ˜ì¼ì</label>
                <input type="date" value={requestData.completionDate}
                  onChange={(e) => handleInputChange('completionDate', e.target.value)}
                  className="w-full px-4 py-2 border border-neutral-300 rounded-lg focus:ring-2 focus:ring-indigo-500" />
              </div>
              <div>
                <label className="block text-sm font-medium text-neutral-700 mb-2">ê²€ìˆ˜ì</label>
                <input type="text" value={requestData.finalInspector}
                  onChange={(e) => handleInputChange('finalInspector', e.target.value)}
                  className="w-full px-4 py-2 border border-neutral-300 rounded-lg focus:ring-2 focus:ring-indigo-500"
                  placeholder="ìµœì¢…ê²€ìˆ˜ ë‹´ë‹¹ìëª…" />
              </div>
              <div>
                <label className="block text-sm font-medium text-neutral-700 mb-2">ì¶”ì </label>
                <input type="text" value={requestData.status}
                  disabled
                  className="w-full px-4 py-2 bg-gray-50 border border-neutral-300 rounded-lg"
                  placeholder="í˜„ì¬ ì§„í–‰ ìƒíƒœ" />
              </div>
              <div>
                <label className="block text-sm font-medium text-neutral-700 mb-2">ì „ì²´ì§„í–‰ë¥ </label>
                <input type="text" disabled
                  className="w-full px-4 py-2 bg-gray-50 border border-neutral-300 rounded-lg"
                  placeholder="ê° ë‹¨ê³„ ì™„ë£Œìœ¨ ìë™ê³„ì‚°" />
              </div>
              <div>
                <label className="block text-sm font-medium text-neutral-700 mb-2">ì§€ì—°ì¼ìˆ˜</label>
                <input type="text" disabled
                  className="w-full px-4 py-2 bg-gray-50 border border-neutral-300 rounded-lg"
                  placeholder="ì˜ˆìƒì¼ ëŒ€ë¹„ ì§€ì—° ìë™ê³„ì‚°" />
              </div>
              <div>
                <label className="block text-sm font-medium text-neutral-700 mb-2">ì•Œë¦¼ì´ë ¥</label>
                <input type="text" disabled
                  className="w-full px-4 py-2 bg-gray-50 border border-neutral-300 rounded-lg"
                  placeholder="ìŠ¹ì¸/ì§€ì—°/ì™„ë£Œ ì•Œë¦¼ ë¡œê·¸" />
              </div>
            </div>
            <div>
              <label className="block text-sm font-medium text-neutral-700 mb-2">ì¢…ë¶€</label>
              <input type="file" accept=".pdf"
                className="w-full px-4 py-2 border border-neutral-300 rounded-lg" />
              <p className="text-xs text-gray-500 mt-1">ìˆ˜ë¦¬ë¦¬í¬íŠ¸ (ìµœì¢… PDF ì¶œë ¥)</p>
            </div>
          </div>
        </div>

        {/* GPS ìœ„ì¹˜ ì •ë³´ */}
        <div className="bg-white rounded-lg border p-4">
          <h4 className="text-lg font-medium text-neutral-900 mb-4 flex items-center gap-2">
            <MapPin className="h-5 w-5" />
            ìœ„ì¹˜ ì •ë³´
          </h4>
          
          {isGettingLocation ? (
            <div className="flex items-center gap-3 p-4 bg-blue-50 rounded-lg">
              <div className="animate-spin rounded-full h-5 w-5 border-b-2 border-blue-500"></div>
              <span className="text-blue-700">ìœ„ì¹˜ ì •ë³´ë¥¼ ê°€ì ¸ì˜¤ëŠ” ì¤‘...</span>
            </div>
          ) : requestData.gpsLocation ? (
            <div className="p-4 bg-green-50 border border-green-200 rounded-lg">
              <div className="flex items-start gap-3">
                <MapPin className="h-5 w-5 text-green-600 mt-0.5" />
                <div>
                  <p className="font-medium text-green-800">ìœ„ì¹˜ ì •ë³´ í™•ì¸ë¨</p>
                  <p className="text-sm text-green-700 mt-1">{requestData.gpsLocation.address}</p>
                </div>
              </div>
            </div>
          ) : (
            <div className="p-4 bg-yellow-50 border border-yellow-200 rounded-lg">
              <div className="flex items-center justify-between">
                <div className="flex items-center gap-3">
                  <AlertTriangle className="h-5 w-5 text-yellow-600" />
                  <span className="text-yellow-800">ìœ„ì¹˜ ì •ë³´ê°€ í•„ìš”í•©ë‹ˆë‹¤</span>
                </div>
                <button
                  onClick={getCurrentLocation}
                  className="btn-secondary text-sm"
                >
                  ìœ„ì¹˜ ê°€ì ¸ì˜¤ê¸°
                </button>
              </div>
            </div>
          )}
        </div>

        {/* ì‚¬ì§„ ì²¨ë¶€ */}
        <div className="bg-white rounded-lg border p-4">
          <h4 className="text-lg font-medium text-neutral-900 mb-4 flex items-center gap-2">
            <Camera className="h-5 w-5" />
            ë¬¸ì œ ì‚¬ì§„
          </h4>
          
          <div className="border-2 border-dashed border-neutral-300 rounded-lg p-6 text-center">
            <Upload className="mx-auto h-12 w-12 text-neutral-400 mb-4" />
            <p className="text-neutral-600 mb-2">ë¬¸ì œ ìƒí™©ì„ ë³´ì—¬ì£¼ëŠ” ì‚¬ì§„ì„ ì—…ë¡œë“œí•˜ì„¸ìš”</p>
            <input
              type="file"
              multiple
              accept="image/*"
              onChange={handleImageUpload}
              className="hidden"
              id="image-upload"
            />
            <label
              htmlFor="image-upload"
              className="btn-primary cursor-pointer"
            >
              íŒŒì¼ ì„ íƒ
            </label>
          </div>
          
          {requestData.issueImages.length > 0 && (
            <div className="mt-4">
              <h5 className="text-sm font-medium text-neutral-700 mb-2">ì—…ë¡œë“œëœ ì´ë¯¸ì§€</h5>
              <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
                {requestData.issueImages.map((image: File, index: number) => (
                  <div key={index} className="relative">
                    <img
                      src={URL.createObjectURL(image)}
                      alt={`ë¬¸ì œ ì‚¬ì§„ ${index + 1}`}
                      className="w-full h-24 object-cover rounded-lg"
                    />
                    <button
                      onClick={() => removeImage(index)}
                      className="absolute -top-2 -right-2 bg-red-500 text-white rounded-full p-1 hover:bg-red-600"
                    >
                      <X className="h-3 w-3" />
                    </button>
                  </div>
                ))}
              </div>
            </div>
          )}
        </div>
      </div>
    </div>
  );
};

export default RepairRequest;
